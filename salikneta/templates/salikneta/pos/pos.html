<!DOCTYPE html>
<html lang="en">

{% include 'salikneta/includes/head.html' %}
{% load staticfiles %}
<style>
    .selectable{
        cursor: pointer;
    }
    .row.no-gutter {
  margin-left: 0;
  margin-right: 0;
}

.row.no-gutter [class*='col-']:not(:first-child),
.row.no-gutter [class*='col-']:not(:last-child) {
  padding-right: 0;
  padding-left: 0;

}
    .right_aln {
    text-align: right;
}
</style>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<body>
  <section id="container">
      {% include 'salikneta/includes/pos_header.html' %}

      <section class="wrapper site-min-height">
        <div class="row">
          <div class="col-lg-12">
            <div class="col-lg-6">
                <form method="post" action="">
                  <div class="custom-box" style="padding-left: 15px;padding-right: 15px;padding-top: 0;">
                      <div id="print_div">
                      <div class="row text-left" style="background-color: #03DAC6;padding: 10px">
                          <div class="col-md-6 text-left">
                            <h4 style="margin: 0;padding: 0; color: black">Sales Invoice {{ si_num }}</h4>
                          </div>
                          <div class="col-md-6 text-right">
                            <h6 style="margin: 0;padding: 0;">{{ date|date:"M d, Y" }}</h6>
                          </div>
                      </div>
                      <div class="row">
                            <table class="table table-hover">
                            <thead>
                              <tr>
                                <th style="text-align: left; width:37%" >Item Name</th>
                                <th style="text-align: right; width:20%">Qty</th>
                                <th style="text-align: right; width:5%">Disc(%)</th>
                                <th style="text-align: right; width:20%">Amount Due</th>
                              </tr>
                            </thead>
                            <tbody id="checkout_tbl">

                            </tbody>
                          </table>
                          <hr>
                          <div class="row" style="padding: 10px">
                              <div class="col-md-6 text-left">
                                  <b>Net Total</b>
                              </div>
                              <div class="col-md-6 text-right">
                                  P<b id="net_total"> 0.0</b>
                              </div>
                          </div>
                        </div>
                      </div>
                      <div>
                        <button class="btn btn-success" type="submit"><i class="fa fa-check"></i> Pay</button>
                        <a class="btn btn-default" href="" onclick="resetPOS()"><i class="fa fa-refresh"></i> Clear</a>
                        <a class="btn btn-info" href=""><i class="fa fa-print"></i> Print Preview</a>
                      </div>
                  </div>
                </form>
            </div>
            <div class="col-lg-6">
              <div class="custom-box" style="padding-left: 15px;padding-right: 15px;padding-top: 0;">
              <div class="row no-gutter" style="padding: 10px;padding-bottom: 0px">
                  <div class="col-md-9" style="margin: 0px">

              <input type="text" class="form-control input-sm" id="item_filter" placeholder="Search Item"/>
                  </div>
                  <div class="col-md-3">
                      <select class="form-control input-sm" id="cat_filter">
                          <option value="null" selected>No Category Filter</option>
                          {% for cat in categories %}
                            <option value="{{ cat.name }}">{{ cat.name }}</option>
                          {% endfor %}
                      </select>
                  </div>
              </div>
              <div class="row " id="item_container" style="padding-top: 0; max-height: 100vh;overflow-y: scroll;margin-top: 0px;">
                  <hr style="border-color: silver">
            {% for p in products %}
                  <div class="col-md-4 mb selectable"
                       product_name="{{ p.name }}"
                       curr_stock="{{ p.unitsInStock }}"
                       category="{{ p.idCategory.name }}"
                       unitMeasure="{{ p.unitOfMeasure }}"
                       SKU="{{ p.SKU }}"

                       product_code="{{ p.get_product_code }}"
                       product_price="{{ p.suggestedUnitPrice }}">
                    <div class="w3-card-4" style="width:100%">
                        <img src="/static/media/{{ p.img_path }}" style="width:100%;height: 180px">
                        <div class="w3-container" style="text-align: left">
                          [{{ p.get_product_code }}]<b style="color: black; font-size: 12px">{{ p.name }}</b>
                            <div>
                          <b style="float:right;font-size: 10px" class="text-muted">{{ p.idCategory.name }}</b>
                          <p style="float:left;font-size: 10px" class="text-muted">P{{ p.suggestedUnitPrice }}/{{ p.unitOfMeasure }}</p>
                            </div>
                        </div>
                    </div>
                  </div>
            {% endfor %}
              </div>
              <div>
              </div>
              </div>
            </div>
            <!-- end col-4 -->
          </div>
          <!--  /col-lg-12 -->
        </div>
        <!--  /row -->
      </section>
    <!-- /MAIN CONTENT -->
    <!--main content end-->
  </section>
</body>
</html>
<script>
    let item_ids = 0;
    let net_total = 0.0;
    function remove_row(id){
        $("#item_"+id).remove();
        compute_net();
    }
    function resetPOS() {
        item_ids =0;
        $("#checkout_tbl").empty();
        compute_net();
    }
    function compute_price(id) {
        gross = $("#qty_"+id).val() * $("#qty_"+id).attr("price") ;
        disc = parseFloat($("#disc_"+id).val()/100) * gross;

        $("#disp_disc_"+id).html(parseFloat(disc).toFixed(2));
        $("#amt_"+id).html(parseFloat(gross - disc).toFixed(2));
        compute_net();
    }
    function compute_net(){
        net_total = 0.0;
        $('.amt').each(function(i, obj) {
            console.log(obj);
            net_total += Number(parseFloat($(obj).html()).toFixed(2));
        });

      $("#net_total").html(parseFloat(net_total).toFixed(2));
    }
    $( ".selectable" ).click(function() {
      let str = '<tr id="item_'+item_ids+'">';
      str += '<td style="text-align: left"><input type="hidden" name="prod_codes[]" value="'+($(this).attr('product_code')-1000)+'">';
      str+= $(this).attr('product_name');
      str += ' <button type="button" onclick="remove_row('+item_ids+')" class="btn btn-round btn-warning" style="padding-bottom:0px;padding-top:0px;padding-right: 3px;padding-left: 3px"><i class="fa fa-remove"></i></button>';
      str += '<br><p class="text-muted">['+$(this).attr('product_code')+']</p></td><td style="text-align: right"> ';
      str+= '<input type="text" onkeyup="compute_price('+item_ids+')" name="qty[]" price="'+$(this).attr('product_price')+'" ids="'+item_ids+'" id="qty_'+item_ids+'" class="right_aln qty form-control input-sm"  value="1"/>';
      str+= '<span class="help-block">@ '+$(this).attr('product_price')+'/'+$(this).attr('unitMeasure')+'</span></td>';
      str+= '<td style="text-align: right"><input type="text" name="disc[]" onkeyup="compute_price('+item_ids+')" id="disc_'+item_ids+'"class="disc form-control input-sm right_aln"  value="0"/>';
      str+= '<span class="help-block">(<p id="disp_disc_'+item_ids+'" style="display: inline">0.0</p>)</span></td>';
      str+= '<td style="text-align: right">P<b id="amt_'+item_ids+'" class="amt">'+$(this).attr('product_price')+'</b></td>';
      $("#checkout_tbl").append(str);
      item_ids +=1;
      net_total += parseFloat($(this).attr('product_price'));
      $("#net_total").html(parseFloat(net_total).toFixed(2));
    });

    $(document).ready(function(){
      $("#item_filter").on("keyup", function() {
        var value = $(this).val().toLowerCase();
        var filter_value = $("#cat_filter").find(":selected").text().toLowerCase();
        $("#item_container .selectable").filter(function() {
           if(filter_value !== "no category filter"){
                $(this).toggle($(this).attr("category").toLowerCase() === value);
           }

           $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
        });
      });
      $("#cat_filter").on("change", function() {
        var value = $(this).find(":selected").text().toLowerCase();
        $("#item_container .selectable").filter(function() {
           if(value !== "no category filter"){
                $(this).toggle($(this).attr("category").toLowerCase() === value);
           }else{
                $(this).toggle($(this).attr("category").toLowerCase() !== value);
           }
        });
      });
    });

</script>
